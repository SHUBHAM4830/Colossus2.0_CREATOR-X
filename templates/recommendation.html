{% extends 'base.html' %}
{% load static %}

{% block title %}Crop Recommendation - Krishibazaar{% endblock %}

{% block content %}
<<html>
    <head>
        <style>
            /* Styles for the crop recommendation feature */
.tab-content {
    background-color: #f9f9f9;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.tab-content h2 {
    color: #2e7d32;
    margin-bottom: 20px;
    text-align: center;
}

.recommendation-form {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
}

.btn {
    background-color: #2e7d32;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    grid-column: span 2;
    transition: background-color 0.3s;
}

.btn:hover {
    background-color: #1b5e20;
}

.recommendation-result {
    margin-top: 25px;
    padding: 15px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.recommendation-result h3 {
    color: #2e7d32;
    margin-bottom: 10px;
    text-align: center;
}

.recommendations-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.crop-card {
    background-color: #f1f8e9;
    border-radius: 8px;
    padding: 15px;
    border-left: 4px solid #2e7d32;
}

.crop-card h4 {
    color: #2e7d32;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 18px;
}

.crop-details {
    margin-top: 10px;
}

.crop-metric {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.metric-label {
    flex: 1;
    font-weight: 500;
}

.metric-bar {
    flex: 2;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    overflow: hidden;
    margin: 0 10px;
}

.metric-fill {
    height: 100%;
    background-color: #4caf50;
    border-radius: 5px;
}

.metric-value {
    width: 40px;
    text-align: right;
    font-weight: 500;
}

.crop-info {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}

.crop-info p {
    margin: 5px 0;
    font-size: 14px;
}

.recommendation-footer {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
    font-size: 14px;
    color: #666;
    text-align: center;
}

.loading {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 20px;
}

/* Language selector styles */
.language-selector {
    text-align: right;
    margin-bottom: 15px;
}

.language-btn {
    background-color: #f1f8e9;
    border: 1px solid #2e7d32;
    color: #2e7d32;
    padding: 8px 12px;
    margin-left: 5px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
}

.language-btn:hover {
    background-color: #e8f5e9;
}

.language-btn.active {
    background-color: #2e7d32;
    color: white;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .recommendation-form {
        grid-template-columns: 1fr;
    }
    
    .btn {
        grid-column: span 1;
    }
}
        </style>
    </head>
    <body>
        <div class="language-selector">
            <button class="language-btn active" onclick="changeLanguage('en')">English</button>
            <button class="language-btn" onclick="changeLanguage('hi')">हिंदी</button>
            <button class="language-btn" onclick="changeLanguage('kn')">ಕನ್ನಡ</button>
        </div>

        <div id="recommend" class="tab-content">
            <h2 class="lang-en">Get Crop Recommendations</h2>
            <h2 class="lang-hi" style="display:none;">फसल अनुशंसाएँ प्राप्त करें</h2>
            <h2 class="lang-kn" style="display:none;">ಬೆಳೆ ಶಿಫಾರಸುಗಳನ್ನು ಪಡೆಯಿರಿ</h2>
            
            <form class="recommendation-form" onsubmit="getCropRecommendation(event)">
                <div class="form-group">
                    <label class="lang-en">Soil Type</label>
                    <label class="lang-hi" style="display:none;">मिट्टी का प्रकार</label>
                    <label class="lang-kn" style="display:none;">ಮಣ್ಣಿನ ಪ್ರಕಾರ</label>
                    <select id="soilType" required>
                        <option value="" class="lang-en"></option>
                        <option value="" class="lang-hi" style="display:none;">मिट्टी का प्रकार चुनें</option>
                        <option value="" class="lang-kn" style="display:none;">ಮಣ್ಣಿನ ಪ್ರಕಾರವನ್ನು ಆಯ್ಕೆಮಾಡಿ</option>
                        <option value="clay" class="lang-en">Clay</option>
                        <option value="clay" class="lang-hi" style="display:none;">चिकनी मिट्टी</option>
                        <option value="clay" class="lang-kn" style="display:none;">ಜೇಡಿ ಮಣ್ಣು</option>
                        <option value="loam" class="lang-en">Loam</option>
                        <option value="loam" class="lang-hi" style="display:none;">दोमट मिट्टी</option>
                        <option value="loam" class="lang-kn" style="display:none;">ಮರಳು ಮಣ್ಣು</option>
                        <option value="sandy" class="lang-en">Sandy</option>
                        <option value="sandy" class="lang-hi" style="display:none;">रेतीली मिट्टी</option>
                        <option value="sandy" class="lang-kn" style="display:none;">ಮರಳು ಮಣ್ಣು</option>
                        <option value="silt" class="lang-en">Silt</option>
                        <option value="silt" class="lang-hi" style="display:none;">गाद मिट्टी</option>
                        <option value="silt" class="lang-kn" style="display:none;">ಹೂಳು ಮಣ್ಣು</option>
                        <option value="black" class="lang-en">Black</option>
                        <option value="black" class="lang-hi" style="display:none;">काली मिट्टी</option>
                        <option value="black" class="lang-kn" style="display:none;">ಕಪ್ಪು ಮಣ್ಣು</option>
                        <option value="red" class="lang-en">Red</option>
                        <option value="red" class="lang-hi" style="display:none;">लाल मिट्टी</option>
                        <option value="red" class="lang-kn" style="display:none;">ಕೆಂಪು ಮಣ್ಣು</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="lang-en">Climate Zone</label>
                    <label class="lang-hi" style="display:none;">जलवायु क्षेत्र</label>
                    <label class="lang-kn" style="display:none;">ಹವಾಮಾನ ವಲಯ</label>
                    <select id="climateZone" required>
                        <option value="" class="lang-en"></option>
                        <option value="" class="lang-hi" style="display:none;">जलवायु क्षेत्र चुनें</option>
                        <option value="" class="lang-kn" style="display:none;">ಹವಾಮಾನ ವಲಯವನ್ನು ಆಯ್ಕೆಮಾಡಿ</option>
                        <option value="tropical" class="lang-en">Tropical</option>
                        <option value="tropical" class="lang-hi" style="display:none;">उष्णकटिबंधीय</option>
                        <option value="tropical" class="lang-kn" style="display:none;">ಉಷ್ಣವಲಯ</option>
                        <option value="subtropical" class="lang-en">Subtropical</option>
                        <option value="subtropical" class="lang-hi" style="display:none;">उपोष्णकटिबंधीय</option>
                        <option value="subtropical" class="lang-kn" style="display:none;">ಉಪ-ಉಷ್ಣವಲಯ</option>
                        <option value="temperate" class="lang-en">Temperate</option>
                        <option value="temperate" class="lang-hi" style="display:none;">समशीतोष्ण</option>
                        <option value="temperate" class="lang-kn" style="display:none;">ಸಮಶೀತೋಷ್ಣ</option>
                        <option value="arid" class="lang-en">Arid</option>
                        <option value="arid" class="lang-hi" style="display:none;">शुष्क</option>
                        <option value="arid" class="lang-kn" style="display:none;">ಬರಗಾಲದ</option>
                        <option value="semiarid" class="lang-en">Semi-Arid</option>
                        <option value="semiarid" class="lang-hi" style="display:none;">अर्ध-शुष्क</option>
                        <option value="semiarid" class="lang-kn" style="display:none;">ಅರೆ-ಬರಗಾಲದ</option>
                        <option value="continental" class="lang-en">Continental</option>
                        <option value="continental" class="lang-hi" style="display:none;">महाद्वीपीय</option>
                        <option value="continental" class="lang-kn" style="display:none;">ಖಂಡೀಯ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="lang-en">Field Area (acres)</label>
                    <label class="lang-hi" style="display:none;">खेत का क्षेत्रफल (एकड़)</label>
                    <label class="lang-kn" style="display:none;">ಹೊಲದ ವಿಸ್ತೀರ್ಣ (ಎಕರೆಗಳು)</label>
                    <input type="number" id="fieldArea" required min="0.1" step="0.1">
                </div>

                <div class="form-group">
                    <label class="lang-en">Soil pH (if known)</label>
                    <label class="lang-hi" style="display:none;">मिट्टी का पीएच (यदि ज्ञात हो)</label>
                    <label class="lang-kn" style="display:none;">ಮಣ್ಣಿನ pH (ತಿಳಿದಿದ್ದರೆ)</label>
                    <input type="number" id="soilPH" min="0" max="14" step="0.1">
                </div>

                <div class="form-group">
                    <label class="lang-en">Average Rainfall (mm/year)</label>
                    <label class="lang-hi" style="display:none;">औसत वर्षा (मिमी/वर्ष)</label>
                    <label class="lang-kn" style="display:none;">ಸರಾಸರಿ ಮಳೆ (ಮಿ.ಮೀ/ವರ್ಷ)</label>
                    <input type="number" id="rainfall" min="0" step="10">
                </div>

                <div class="form-group">
                    <label class="lang-en">Irrigation Availability</label>
                    <label class="lang-hi" style="display:none;">सिंचाई की उपलब्धता</label>
                    <label class="lang-kn" style="display:none;">ನೀರಾವರಿ ಲಭ್ಯತೆ</label>
                    <select id="irrigationMethod" required>
                        <option value="" class="lang-en"></option>
                        <option value="" class="lang-hi" style="display:none;">सिंचाई पद्धति चुनें</option>
                        <option value="" class="lang-kn" style="display:none;">ನೀರಾವರಿ ವಿಧಾನವನ್ನು ಆಯ್ಕೆಮಾಡಿ</option>
                        <option value="drip" class="lang-en">Drip Irrigation</option>
                        <option value="drip" class="lang-hi" style="display:none;">ड्रिप सिंचाई</option>
                        <option value="drip" class="lang-kn" style="display:none;">ಹನಿ ನೀರಾವರಿ</option>
                        <option value="sprinkler" class="lang-en">Sprinkler</option>
                        <option value="sprinkler" class="lang-hi" style="display:none;">स्प्रिंकलर</option>
                        <option value="sprinkler" class="lang-kn" style="display:none;">ಸಿಂಪರಣೆ</option>
                        <option value="flood" class="lang-en">Flood Irrigation</option>
                        <option value="flood" class="lang-hi" style="display:none;">बाढ़ सिंचाई</option>
                        <option value="flood" class="lang-kn" style="display:none;">ಹರಿವು ನೀರಾವರಿ</option>
                        <option value="rainfed" class="lang-en">Rainfed Only</option>
                        <option value="rainfed" class="lang-hi" style="display:none;">केवल वर्षा आधारित</option>
                        <option value="rainfed" class="lang-kn" style="display:none;">ಮಳೆ ಆಧಾರಿತ ಮಾತ್ರ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="lang-en">Growing Season</label>
                    <label class="lang-hi" style="display:none;">उगाने का मौसम</label>
                    <label class="lang-kn" style="display:none;">ಬೆಳೆಯುವ ಋತು</label>
                    <select id="growingSeason" required>
                        <option value="" class="lang-en"></option>
                        <option value="" class="lang-hi" style="display:none;">उगाने का मौसम चुनें</option>
                        <option value="" class="lang-kn" style="display:none;">ಬೆಳೆಯುವ ಋತುವನ್ನು ಆಯ್ಕೆಮಾಡಿ</option>
                        <option value="spring" class="lang-en">Spring</option>
                        <option value="spring" class="lang-hi" style="display:none;">वसंत</option>
                        <option value="spring" class="lang-kn" style="display:none;">ವಸಂತ</option>
                        <option value="summer" class="lang-en">Summer</option>
                        <option value="summer" class="lang-hi" style="display:none;">गर्मी</option>
                        <option value="summer" class="lang-kn" style="display:none;">ಬೇಸಿಗೆ</option>
                        <option value="fall" class="lang-en">Fall</option>
                        <option value="fall" class="lang-hi" style="display:none;">पतझड़</option>
                        <option value="fall" class="lang-kn" style="display:none;">ಶರತ್ಕಾಲ</option>
                        <option value="winter" class="lang-en">Winter</option>
                        <option value="winter" class="lang-hi" style="display:none;">सर्दी</option>
                        <option value="winter" class="lang-kn" style="display:none;">ಚಳಿಗಾಲ</option>
                        <option value="yearround" class="lang-en">Year-round</option>
                        <option value="yearround" class="lang-hi" style="display:none;">साल भर</option>
                        <option value="yearround" class="lang-kn" style="display:none;">ವರ್ಷಪೂರ್ತಿ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="lang-en">Market Preference</label>
                    <label class="lang-hi" style="display:none;">बाजार प्राथमिकता</label>
                    <label class="lang-kn" style="display:none;">ಮಾರುಕಟ್ಟೆ ಆದ್ಯತೆ</label>
                    <select id="marketPreference">
                        <option value="" class="lang-en"></option>
                        <option value="" class="lang-hi" style="display:none;">बाजार प्राथमिकता चुनें</option>
                        <option value="" class="lang-kn" style="display:none;">ಮಾರುಕಟ್ಟೆ ಆದ್ಯತೆಯನ್ನು ಆಯ್ಕೆಮಾಡಿ</option>
                        <option value="local" class="lang-en">Local Market</option>
                        <option value="local" class="lang-hi" style="display:none;">स्थानीय बाजार</option>
                        <option value="local" class="lang-kn" style="display:none;">ಸ್ಥಳೀಯ ಮಾರುಕಟ್ಟೆ</option>
                        <option value="export" class="lang-en">Export Market</option>
                        <option value="export" class="lang-hi" style="display:none;">निर्यात बाजार</option>
                        <option value="export" class="lang-kn" style="display:none;">ರಫ್ತು ಮಾರುಕಟ್ಟೆ</option>
                        <option value="processing" class="lang-en">Processing Industry</option>
                        <option value="processing" class="lang-hi" style="display:none;">प्रसंस्करण उद्योग</option>
                        <option value="processing" class="lang-kn" style="display:none;">ಸಂಸ್ಕರಣಾ ಉದ್ಯಮ</option>
                        <option value="subsistence" class="lang-en">Subsistence Farming</option>
                        <option value="subsistence" class="lang-hi" style="display:none;">निर्वाह खेती</option>
                        <option value="subsistence" class="lang-kn" style="display:none;">ಜೀವನಾಧಾರ ಕೃಷಿ</option>
                    </select>
                </div>

                <button type="submit" class="btn lang-en">Get Crop Recommendation</button>
                <button type="submit" class="btn lang-hi" style="display:none;">फसल अनुशंसा प्राप्त करें</button>
                <button type="submit" class="btn lang-kn" style="display:none;">ಬೆಳೆ ಶಿಫಾರಸು ಪಡೆಯಿರಿ</button>
            </form>
            
            <div id="recommendationResult" class="recommendation-result" style="display: none;">
                <!-- Crop recommendations will be displayed here -->
            </div>
        </div>

      
{% endblock %}
<script>
    // Function to handle language change
    function changeLanguage(lang) {
        // Hide all language elements
        document.querySelectorAll('.lang-en, .lang-hi, .lang-kn').forEach(el => {
            el.style.display = 'none';
        });
        
        // Show only the selected language elements
        document.querySelectorAll('.lang-' + lang).forEach(el => {
            el.style.display = '';
        });
        
        // Update active button
        document.querySelectorAll('.language-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Store the selected language
        localStorage.setItem('selectedLanguage', lang);
    }
    
    // Load saved language preference if available
    document.addEventListener('DOMContentLoaded', function() {
        const savedLang = localStorage.getItem('selectedLanguage') || 'en';
        changeLanguage(savedLang);
    });

    // Function to handle crop recommendation form submission
   // Function to handle crop recommendation form submission
function getCropRecommendation(event) {
event.preventDefault();

// Get form values
const soilType = document.getElementById('soilType').value;
const climateZone = document.getElementById('climateZone').value;
const fieldArea = document.getElementById('fieldArea').value;
const soilPH = document.getElementById('soilPH').value;
const rainfall = document.getElementById('rainfall').value;
const irrigationMethod = document.getElementById('irrigationMethod').value;
const growingSeason = document.getElementById('growingSeason').value;
const marketPreference = document.getElementById('marketPreference').value;

// Get current language
const currentLang = localStorage.getItem('selectedLanguage') || 'en';

// Display loading state
const resultDiv = document.getElementById('recommendationResult');
let loadingText = 'Analyzing your farm conditions...';
if (currentLang === 'hi') {
loadingText = 'आपकी खेत की स्थिति का विश्लेषण किया जा रहा है...';
} else if (currentLang === 'kn') {
loadingText = 'ನಿಮ್ಮ ಕೃಷಿ ಪರಿಸ್ಥಿತಿಗಳನ್ನು ವಿಶ್ಲೇಷಿಸಲಾಗುತ್ತಿದೆ...';
}
resultDiv.innerHTML = <p class="loading">${loadingText}</p>;
resultDiv.style.display = 'block';

// Simulate processing time
setTimeout(() => {
// Get recommended crops based on input parameters
const recommendations = generateCropRecommendations(
    soilType, 
    climateZone, 
    fieldArea, 
    soilPH, 
    rainfall, 
    irrigationMethod, 
    growingSeason,
    marketPreference
);

// Display recommendations with current language
displayCropRecommendations(recommendations, currentLang);
}, 1500);
}

    // Function to generate crop recommendations based on input parameters
    function generateCropRecommendations(soilType, climateZone, fieldArea, soilPH, rainfall, irrigationMethod, growingSeason, marketPreference) {
        // This is a simplified recommendation logic
        // In a real application, this would be more sophisticated
        
        let recommendedCrops = [];
        let profitabilityScores = {};
        let sustainabilityScores = {};
        let waterRequirements = {};
        let growingPeriods = {};
        
        // Base recommendations on soil type
        const soilBasedCrops = {
            'clay': ['rice', 'wheat', 'cabbage', 'broccoli'],
            'loam': ['corn', 'soybeans', 'vegetables', 'fruits', 'wheat'],
            'sandy': ['potatoes', 'carrots', 'peanuts', 'watermelon'],
            'silt': ['tomatoes', 'leafy greens', 'beans', 'corn'],
            'black': ['cotton', 'sugarcane', 'wheat', 'pulses'],
            'red': ['groundnut', 'millet', 'cotton', 'sugarcane']
        };
        
        // Climate-based crop filtering
        const climateBasedCrops = {
            'tropical': ['rice', 'sugarcane', 'coconut', 'banana', 'pineapple'],
            'subtropical': ['citrus', 'tea', 'cotton', 'tobacco', 'mango'],
            'temperate': ['wheat', 'barley', 'oats', 'apples', 'cherries'],
            'arid': ['dates', 'millet', 'chickpea', 'olive'],
            'semiarid': ['sorghum', 'millet', 'safflower', 'sesame'],
            'continental': ['corn', 'soybeans', 'sunflower', 'sugar beet']
        };
        
        // Season-based recommendations
        const seasonBasedCrops = {
            'spring': ['corn', 'soybeans', 'vegetables', 'melons'],
            'summer': ['rice', 'cotton', 'vegetables', 'sunflower'],
            'fall': ['wheat', 'barley', 'canola', 'peas'],
            'winter': ['winter wheat', 'pulses', 'oilseed', 'barley'],
            'yearround': ['sugarcane', 'banana', 'coconut', 'cassava']
        };
        
        // Get initial crop list based on soil
        let potentialCrops = soilBasedCrops[soilType] || [];
        
        // Filter by climate zone
        const climateCrops = climateBasedCrops[climateZone] || [];
        potentialCrops = potentialCrops.filter(crop => climateCrops.includes(crop));
        
        // If filtered too much, add some climate crops
        if (potentialCrops.length < 2) {
            potentialCrops = potentialCrops.concat(climateCrops.slice(0, 3));
        }
        
        // Add season-specific crops
        const seasonCrops = seasonBasedCrops[growingSeason] || [];
        potentialCrops = [...new Set([...potentialCrops, ...seasonCrops.slice(0, 2)])];
        
        // Refine based on irrigation
        if (irrigationMethod === 'rainfed' && rainfall < 500) {
            // For low rainfall areas with no irrigation, focus on drought-resistant crops
            potentialCrops = potentialCrops.filter(crop => 
                ['millet', 'sorghum', 'chickpea', 'safflower'].includes(crop));
            
            // If filtered too much, add these crops
            if (potentialCrops.length < 2) {
                potentialCrops = potentialCrops.concat(['millet', 'sorghum']);
            }
        }
        
        // pH-based adjustments if pH is provided
         if (soilPH) {
const phValue = parseFloat(soilPH);
if (phValue < 5.5) {
    // Acidic soil crops
    potentialCrops = potentialCrops.filter(crop => 
        !['alfalfa', 'asparagus', 'barley'].includes(crop));
} else if (phValue > 7.5) {
    // Alkaline soil crops
    potentialCrops = potentialCrops.filter(crop => 
        !['potatoes', 'blueberries', 'strawberries'].includes(crop));
}
}

// Market preference adjustments
if (marketPreference === 'export') {
// Add export-oriented crops
potentialCrops = [...new Set([...potentialCrops, 'coffee', 'tea', 'exotic fruits'])];
} else if (marketPreference === 'processing') {
// Add processing-friendly crops
potentialCrops = [...new Set([...potentialCrops, 'tomatoes', 'potatoes', 'sweet corn'])];
}

// Remove duplicates and limit to top 5
recommendedCrops = [...new Set(potentialCrops)].slice(0, 5);

// Generate additional information for each recommended crop
recommendedCrops.forEach(crop => {
// Assign profitability scores (1-10)
profitabilityScores[crop] = Math.floor(Math.random() * 4) + 6; // 6-10 range

// Assign sustainability scores (1-10)
sustainabilityScores[crop] = Math.floor(Math.random() * 4) + 6; // 6-10 range

// Assign water requirements (low, medium, high)
const waterLevels = ['Low', 'Medium', 'High'];
waterRequirements[crop] = waterLevels[Math.floor(Math.random() * 3)];

// Assign growing periods (in months)
growingPeriods[crop] = Math.floor(Math.random() * 6) + 2; // 2-7 months
});

return {
crops: recommendedCrops,
profitability: profitabilityScores,
sustainability: sustainabilityScores,
waterRequirements: waterRequirements,
growingPeriods: growingPeriods
};
}

// Function to display crop recommendations
// Function to display crop recommendations in multiple languages
function displayCropRecommendations(recommendations, language) {
const resultDiv = document.getElementById('recommendationResult');

// Multilingual text content
const texts = {
'en': {
    title: 'Recommended Crops for Your Farm',
    subtitle: 'Based on your soil type, climate, and other factors, here are our top crop recommendations:',
    profitability: 'Profitability:',
    sustainability: 'Sustainability:',
    waterNeed: 'Water Need:',
    growingPeriod: 'Growing Period:',
    months: 'months',
    note: 'Note: These recommendations are based on the information you provided. For optimal results, consider conducting a soil test and consulting with a local agricultural extension service.',
    close: 'Close'
},
'hi': {
    title: 'आपके खेत के लिए अनुशंसित फसलें',
    subtitle: 'आपकी मिट्टी के प्रकार, जलवायु और अन्य कारकों के आधार पर, यहां हमारी शीर्ष फसल अनुशंसाएं हैं:',
    profitability: 'लाभप्रदता:',
    sustainability: 'स्थिरता:',
    waterNeed: 'पानी की आवश्यकता:',
    growingPeriod: 'उगाने की अवधि:',
    months: 'महीने',
    note: 'नोट: ये अनुशंसाएं आपके द्वारा प्रदान की गई जानकारी पर आधारित हैं। सर्वोत्तम परिणामों के लिए, मिट्टी का परीक्षण करवाने और स्थानीय कृषि विस्तार सेवा से परामर्श करने पर विचार करें।',
    close: 'बंद करें'
},
'kn': {
    title: 'ನಿಮ್ಮ ಕೃಷಿಯಲ್ಲಿಗೆ ಶಿಫಾರಸು ಮಾಡಿದ ಬೆಳೆಗಳು',
    subtitle: 'ನಿಮ್ಮ ಮಣ್ಣಿನ ಪ್ರಕಾರ, ಹವಾಮಾನ ಮತ್ತು ಇತರ ಅಂಶಗಳ ಆಧಾರದಲ್ಲಿ, ಇಲ್ಲಿ ನಮ್ಮ ಅತ್ಯುತ್ತಮ ಬೆಳೆಗಳ ಶಿಫಾರಸುಗಳಿವೆ:',
    profitability: 'ಲಾಭದಾಯಕತೆ:',
    sustainability: 'ಸುಸ್ಥಿರತೆ:',
    waterNeed: 'ನೀರಿನ ಅಗತ್ಯ:',
    growingPeriod: 'ಬೆಳೆಯುವ ಅವಧಿ:',
    months: 'ತಿಂಗಳುಗಳು',
    note: 'ಗಮನಿಸಿ: ಈ ಶಿಫಾರಸುಗಳು ನೀವು ಒದಗಿಸಿದ ಮಾಹಿತಿಯ ಆಧಾರದಲ್ಲಿವೆ. ಉತ್ತಮ ಫಲಿತಾಂಶಗಳಿಗಾಗಿ, ಮಣ್ಣಿನ ಪರೀಕ್ಷೆ ನಡೆಸಿ ಮತ್ತು ಸ್ಥಳೀಯ ಕೃಷಿ ವಿಸ್ತರಣಾ ಸೇವೆಯನ್ನು ಸಂಪರ್ಕಿಸಿ.',
    close: 'ಮುಚ್ಚಿರಿ'
}
};

// Crop name translations
const cropTranslations = {
'en': {
    'rice': 'Rice',
    'wheat': 'Wheat',
    'cabbage': 'Cabbage',
    'broccoli': 'Broccoli',
    'corn': 'Corn',
    'soybeans': 'Soybeans',
    'vegetables': 'Vegetables',
    'fruits': 'Fruits',
    'potatoes': 'Potatoes',
    'carrots': 'Carrots',
    'peanuts': 'Peanuts',
    'watermelon': 'Watermelon',
    'tomatoes': 'Tomatoes',
    'leafy greens': 'Leafy Greens',
    'beans': 'Beans',
    'cotton': 'Cotton',
    'sugarcane': 'Sugarcane',
    'pulses': 'Pulses',
    'groundnut': 'Groundnut',
    'millet': 'Millet',
    'coconut': 'Coconut',
    'banana': 'Banana',
    'pineapple': 'Pineapple',
    'citrus': 'Citrus',
    'tea': 'Tea',
    'tobacco': 'Tobacco',
    'mango': 'Mango',
    'barley': 'Barley',
    'oats': 'Oats',
    'apples': 'Apples',
    'cherries': 'Cherries',
    'dates': 'Dates',
    'chickpea': 'Chickpea',
    'olive': 'Olive',
    'sorghum': 'Sorghum',
    'safflower': 'Safflower',
    'sesame': 'Sesame',
    'sunflower': 'Sunflower',
    'sugar beet': 'Sugar Beet',
    'melons': 'Melons',
    'canola': 'Canola',
    'peas': 'Peas',
    'winter wheat': 'Winter Wheat',
    'oilseed': 'Oilseed',
    'cassava': 'Cassava',
    'coffee': 'Coffee',
    'exotic fruits': 'Exotic Fruits',
    'sweet corn': 'Sweet Corn'
},
'hi': {
    'rice': 'चावल',
    'wheat': 'गेहूं',
    'cabbage': 'पत्तागोभी',
    'broccoli': 'ब्रोकली',
    'corn': 'मक्का',
    'soybeans': 'सोयाबीन',
    'vegetables': 'सब्जियां',
    'fruits': 'फल',
    'potatoes': 'आलू',
    'carrots': 'गाजर',
    'peanuts': 'मूंगफली',
    'watermelon': 'तरबूज',
    'tomatoes': 'टमाटर',
    'leafy greens': 'पत्तेदार सब्जियां',
    'beans': 'फलियां',
    'cotton': 'कपास',
    'sugarcane': 'गन्ना',
    'pulses': 'दालें',
    'groundnut': 'मूंगफली',
    'millet': 'बाजरा',
    'coconut': 'नारियल',
    'banana': 'केला',
    'pineapple': 'अनानास',
    'citrus': 'नींबू प्रजाति',
    'tea': 'चाय',
    'tobacco': 'तम्बाकू',
    'mango': 'आम',
    'barley': 'जौ',
    'oats': 'जई',
    'apples': 'सेब',
    'cherries': 'चेरी',
    'dates': 'खजूर',
    'chickpea': 'चना',
    'olive': 'जैतून',
    'sorghum': 'ज्वार',
    'safflower': 'कुसुम',
    'sesame': 'तिल',
    'sunflower': 'सूरजमुखी',
    'sugar beet': 'चुकंदर',
    'melons': 'खरबूजे',
    'canola': 'कैनोला',
    'peas': 'मटर',
    'winter wheat': 'शीतकालीन गेहूं',
    'oilseed': 'तिलहन',
    'cassava': 'कसावा',
    'coffee': 'कॉफी',
    'exotic fruits': 'विदेशी फल',
    'sweet corn': 'स्वीट कॉर्न'
},
'kn': {
    'rice': 'ಅಕ್ಕಿ',
    'wheat': 'ಗೋಧಿ',
    'cabbage': 'ಎಲೆಕೋಸು',
    'broccoli': 'ಬ್ರೊಕೊಲಿ',
    'corn': 'ಜೋಳ',
    'soybeans': 'ಸೋಯಾಬೀನ್',
    'vegetables': 'ತರಕಾರಿಗಳು',
    'fruits': 'ಹಣ್ಣುಗಳು',
    'potatoes': 'ಆಲೂಗಡ್ಡೆ',
    'carrots': 'ಕ್ಯಾರೆಟ್',
    'peanuts': 'ಕಡಲೇಕಾಯಿ',
    'watermelon': 'ಕಲ್ಲಂಗಡಿ',
    'tomatoes': 'ಟೊಮೇಟೊ',
    'leafy greens': 'ಎಲೆ ತರಕಾರಿಗಳು',
    'beans': 'ಬೀನ್ಸ್',
    'cotton': 'ಹತ್ತಿ',
    'sugarcane': 'ಕಬ್ಬು',
    'pulses': 'ಬೇಳೆಕಾಳುಗಳು',
    'groundnut': 'ಕಡಲೇಕಾಯಿ',
    'millet': 'ರಾಗಿ',
    'coconut': 'ತೆಂಗಿನಕಾಯಿ',
    'banana': 'ಬಾಳೆಹಣ್ಣು',
    'pineapple': 'ಅನಾನಸ್',
    'citrus': 'ನಿಂಬೆ ಜಾತಿ',
    'tea': 'ಚಹಾ',
    'tobacco': 'ತಂಬಾಕು',
    'mango': 'ಮಾವಿನಹಣ್ಣು',
    'barley': 'ಬಾರ್ಲಿ',
    'oats': 'ಓಟ್ಸ್',
    'apples': 'ಸೇಬು',
    'cherries': 'ಚೆರ್ರಿ',
    'dates': 'ಖರ್ಜೂರ',
    'chickpea': 'ಕಡಲೆ',
    'olive': 'ಆಲಿವ್',
    'sorghum': 'ಜೋಳ',
    'safflower': 'ಕುಸುಬೆ',
    'sesame': 'ಎಳ್ಳು',
    'sunflower': 'ಸೂರ್ಯಕಾಂತಿ',
    'sugar beet': 'ಸಕ್ಕರೆ ಬೀಟ್',
    'melons': 'ಕಲ್ಲಂಗಡಿ',
    'canola': 'ಕ್ಯಾನೋಲಾ',
    'peas': 'ಬಟಾಣಿ',
    'winter wheat': 'ಚಳಿಗಾಲದ ಗೋಧಿ',
    'oilseed': 'ಎಣ್ಣೆಕಾಳು',
    'cassava': 'ಕಸಾವ',
    'coffee': 'ಕಾಫಿ',
    'exotic fruits': 'ವಿದೇಶಿ ಹಣ್ಣುಗಳು',
    'sweet corn': 'ಸಿಹಿ ಜೋಳ'
}
};

// Water requirement translations
const waterTranslations = {
'en': {
    'Low': 'Low',
    'Medium': 'Medium',
    'High': 'High'
},
'hi': {
    'Low': 'कम',
    'Medium': 'मध्यम',
    'High': 'अधिक'
},
'kn': {
    'Low': 'ಕಡಿಮೆ',
    'Medium': 'ಮಧ್ಯಮ',
    'High': 'ಹೆಚ್ಚು'
}
};

// Use the current language or default to English
const lang = language || 'en';
const t = texts[lang] || texts['en'];
const cropTrans = cropTranslations[lang] || cropTranslations['en'];
const waterTrans = waterTranslations[lang] || waterTranslations['en'];

// Create HTML content for recommendations
let html = `
<h3>${t.title}</h3>
<p>${t.subtitle}</p>
<div class="recommendations-container">
`;

// Add each recommended crop
recommendations.crops.forEach(crop => {
const translatedCrop = cropTrans[crop] || (crop.charAt(0).toUpperCase() + crop.slice(1));
const translatedWater = waterTrans[recommendations.waterRequirements[crop]] || recommendations.waterRequirements[crop];

html += `
    <div class="crop-card">
        <h4>${translatedCrop}</h4>
        <div class="crop-details">
            <div class="crop-metric">
                <span class="metric-label">${t.profitability}</span>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: ${recommendations.profitability[crop] * 10}%"></div>
                </div>
                <span class="metric-value">${recommendations.profitability[crop]}/10</span>
            </div>
            <div class="crop-metric">
                <span class="metric-label">${t.sustainability}</span>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: ${recommendations.sustainability[crop] * 10}%"></div>
                </div>
                <span class="metric-value">${recommendations.sustainability[crop]}/10</span>
            </div>
            <div class="crop-info">
                <p><strong>${t.waterNeed}</strong> ${translatedWater}</p>
                <p><strong>${t.growingPeriod}</strong> ${recommendations.growingPeriods[crop]} ${t.months}</p>
            </div>
        </div>
    </div>
`;
});

html += `
</div>
<div class="recommendation-footer">
    <p><strong>${t.note}</strong></p>
    <button class="btn" onclick="document.getElementById('recommendationResult').style.display='none'">
        ${t.close}
    </button>
</div>
`;

// Update the result div
resultDiv.innerHTML = html;
resultDiv.style.display = 'block';
}
</script>
</body>
</html>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
const form = document.getElementById('cropRecommendationForm');
const resultsContainer = document.getElementById('resultsContainer');
const recommendationsList = document.getElementById('recommendationsList');
const quickFillButton = document.getElementById('quickFillButton');
const newAnalysisButton = document.getElementById('newAnalysisButton');
const soilAnalysis = document.getElementById('soilAnalysis');

let cropChart, nutrientChart;

// Quick fill form with example data
quickFillButton.addEventListener('click', function() {
    document.getElementById('nitrogen').value = 90;
    document.getElementById('phosphorus').value = 42;
    document.getElementById('potassium').value = 43;
    document.getElementById('temperature').value = 20.87;
    document.getElementById('humidity').value = 82;
    document.getElementById('ph').value = 6.5;
    document.getElementById('rainfall').value = 202.9;
});

// New analysis button - scroll back to form on mobile
if (newAnalysisButton) {
    newAnalysisButton.addEventListener('click', function() {
        // On mobile, scroll back to form
        if (window.innerWidth < 992) {
            form.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
}

// Critical fix: Prevent default form submission
form.addEventListener('submit', function(event) {
    // This is essential - stops the form from submitting normally
    event.preventDefault();
    
    if (!form.checkValidity()) {
        event.stopPropagation();
        form.classList.add('was-validated');
        return;
    }
    
    // Get form data
    const formData = {
        nitrogen: parseFloat(document.getElementById('nitrogen').value),
        phosphorus: parseFloat(document.getElementById('phosphorus').value),
        potassium: parseFloat(document.getElementById('potassium').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        humidity: parseFloat(document.getElementById('humidity').value),
        ph: parseFloat(document.getElementById('ph').value),
        rainfall: parseFloat(document.getElementById('rainfall').value),
        region: document.getElementById('region').value || null
    };
    
    // Get CSRF token
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Show loading state
    const submitButton = document.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
    
    // Use proper fetch API with error handling
    fetch('/api/crop-recommendation/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(formData),
        // Important: Add these options to prevent redirect
        redirect: 'follow',
        mode: 'cors',
        cache: 'no-cache'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log("Received data:", data);
        // Process recommendations
        // Handle empty recommendations array
        if (!data.recommendations || data.recommendations.length === 0) {
            // Use mock data if recommendations are empty
            console.log("No recommendations received, using mock data");
            data = getMockRecommendations(formData);
        }
        displayRecommendations(data, formData);
    })
    .catch(error => {
        console.error('Error:', error);
        
        // For demo purposes, show mock data if API fails
        const mockData = getMockRecommendations(formData);
        displayRecommendations(mockData, formData);
    })
    .finally(() => {
        // Reset button
        submitButton.disabled = false;
        submitButton.innerHTML = 'Get Recommendations';
    });
});

function displayRecommendations(data, formData) {
    // Clear previous recommendations
    recommendationsList.innerHTML = '';
    
    // Show results container
    resultsContainer.style.display = 'block';
    
    // Handle the case where recommendations might be empty
    if (!data.recommendations || data.recommendations.length === 0) {
        recommendationsList.innerHTML = '<li class="list-group-item text-center">No specific crop recommendations available for these conditions.</li>';
    } else {
        // Add each recommendation to the list
        data.recommendations.forEach(crop => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.innerHTML = `
                ${crop.name}
                <span class="badge bg-primary rounded-pill">${crop.probability}%</span>
            `;
            recommendationsList.appendChild(listItem);
        });
    }
    
    // Display soil analysis
    soilAnalysis.innerHTML = generateSoilAnalysis(formData);
    
    // Create charts only if recommendations exist
    if (data.recommendations && data.recommendations.length > 0) {
        createCharts(data);
    } else {
        // Create simple chart for soil data only
        createSoilOnlyChart(formData);
    }
    
    // On mobile, scroll to results
    if (window.innerWidth < 992) {
        resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function createSoilOnlyChart(formData) {
    // Destroy previous charts if they exist
    if (cropChart) cropChart.destroy();
    if (nutrientChart) nutrientChart.destroy();
    
    // Create nutrient balance chart
    const nutrientCtx = document.getElementById('nutrientChart').getContext('2d');
    nutrientChart = new Chart(nutrientCtx, {
        type: 'bar',
        data: {
            labels: ['Nitrogen (N)', 'Phosphorus (P)', 'Potassium (K)'],
            datasets: [{
                label: 'Your Soil',
                data: [
                    formData.nitrogen,
                    formData.phosphorus,
                    formData.potassium
                ],
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Level (mg/kg)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Soil Nutrient Analysis'
                }
            }
        }
    });
    
    // Create a placeholder for the pie chart area
    const cropCtx = document.getElementById('cropChart').getContext('2d');
    cropChart = new Chart(cropCtx, {
        type: 'bar',
        data: {
            labels: ['pH', 'Temperature', 'Humidity', 'Rainfall'],
            datasets: [{
                label: 'Your Conditions',
                data: [
                    formData.ph,
                    formData.temperature,
                    formData.humidity,
                    formData.rainfall / 10 // Scale down for visualization
                ],
                backgroundColor: [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(241, 196, 15, 0.7)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)',
                    'rgba(241, 196, 15, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Environmental Conditions'
                }
            }
        }
    });
}

function generateSoilAnalysis(formData) {
    let analysis = '';
    
    // NPK analysis
    if (formData.nitrogen < 50) {
        analysis += '<strong>Nitrogen:</strong> Low - Consider nitrogen-rich fertilizers.<br>';
    } else if (formData.nitrogen > 100) {
        analysis += '<strong>Nitrogen:</strong> High - Suitable for leafy vegetables.<br>';
    } else {
        analysis += '<strong>Nitrogen:</strong> Medium - Good balance for most crops.<br>';
    }
    
    // pH analysis
    if (formData.ph < 5.5) {
        analysis += '<strong>pH:</strong> Acidic - May require liming to raise pH.<br>';
    } else if (formData.ph > 7.5) {
        analysis += '<strong>pH:</strong> Alkaline - Consider soil amendments to lower pH.<br>';
    } else {
        analysis += '<strong>pH:</strong> Neutral - Ideal for most crops.<br>';
    }
    
    // Moisture analysis
    if (formData.rainfall < 80) {
        analysis += '<strong>Moisture:</strong> Low rainfall - Irrigation recommended.<br>';
    } else if (formData.rainfall > 200) {
        analysis += '<strong>Moisture:</strong> High rainfall - Ensure good drainage.<br>';
    } else {
        analysis += '<strong>Moisture:</strong> Moderate rainfall - Good growing conditions.<br>';
    }
    
    return analysis;
}

function createCharts(data) {
    // Destroy previous charts if they exist
    if (cropChart) cropChart.destroy();
    if (nutrientChart) nutrientChart.destroy();
    
    // Create crop recommendation chart
    const cropCtx = document.getElementById('cropChart').getContext('2d');
    cropChart = new Chart(cropCtx, {
        type: 'pie',
        data: {
            labels: data.recommendations.map(crop => crop.name),
            datasets: [{
                data: data.recommendations.map(crop => crop.probability),
                backgroundColor: [
                    'rgba(52, 152, 219, 0.7)',
                    'rgba(46, 204, 113, 0.7)',
                    'rgba(155, 89, 182, 0.7)',
                    'rgba(241, 196, 15, 0.7)',
                    'rgba(230, 126, 34, 0.7)'
                ],
                borderColor: [
                    'rgba(52, 152, 219, 1)',
                    'rgba(46, 204, 113, 1)',
                    'rgba(155, 89, 182, 1)',
                    'rgba(241, 196, 15, 1)',
                    'rgba(230, 126, 34, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                },
                title: {
                    display: true,
                    text: 'Crop Recommendation Probabilities'
                }
            }
        }
    });
    
    // Create nutrient balance chart
    const nutrientCtx = document.getElementById('nutrientChart').getContext('2d');
    nutrientChart = new Chart(nutrientCtx, {
        type: 'bar',
        data: {
            labels: ['Nitrogen (N)', 'Phosphorus (P)', 'Potassium (K)'],
            datasets: [{
                label: 'Your Soil',
                data: [
                    data.soil_data ? data.soil_data.nitrogen : formData.nitrogen,
                    data.soil_data ? data.soil_data.phosphorus : formData.phosphorus,
                    data.soil_data ? data.soil_data.potassium : formData.potassium
                ],
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Level (mg/kg)'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Soil Nutrient Analysis'
                }
            }
        }
    });
}

// Function to generate mock recommendations for demonstration
function getMockRecommendations(formData) {
    // This would be replaced by actual API response in production
    const mockCrops = [
        {name: 'Rice', probability: 85},
        {name: 'Wheat', probability: 70},
        {name: 'Maize', probability: 65},
        {name: 'Cotton', probability: 45},
        {name: 'Sugarcane', probability: 40}
    ];
    
    // Sort based on "suitability" calculated from input data
    // This is simplified logic for demo purposes
    mockCrops.sort((a, b) => {
        // Simple weighted scoring
        const getScore = (crop) => {
            if (crop.name === 'Rice') {
                return (formData.rainfall > 100) ? 95 : 85;
            } else if (crop.name === 'Wheat') {
                return (formData.temperature < 25) ? 90 : 70;
            } else if (crop.name === 'Maize') {
                return (formData.nitrogen > 80) ? 85 : 65;
            } else if (crop.name === 'Cotton') {
                return (formData.ph > 6) ? 75 : 45;
            } else {
                return (formData.potassium > 40) ? 70 : 40;
            }
        };
        
        return getScore(b) - getScore(a);
    });
    
    return {
        recommendations: mockCrops,
        soil_data: {
            nitrogen: formData.nitrogen,
            phosphorus: formData.phosphorus,
            potassium: formData.potassium
        }
    };
}
});
</script>